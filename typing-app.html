<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Typing Speed App – Adaptive + Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14; --card:#121820; --ink:#e6edf3; --muted:#9fb0c0;
      --ok:#27c93f; --bad:#ff5555; --accent:#5aa9ff; --caret:#ffd166; --warn:#ffcc00;
      --key:#1a222c; --key2:#1e2834; --key-border:#2b394a;
      --heat1:#203040; --heat2:#2a4964; --heat3:#3a6d93; --heat4:#5aa9ff; --heat5:#ffd166;
      --focus:#88c0ff66;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --round: 12px;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --ink:#0b0f14; --muted:#4a5568;
      --ok:#14823a; --bad:#d90429; --accent:#2563eb; --caret:#b45309; --warn:#b7791f;
      --key:#edf2f7; --key2:#e2e8f0; --key-border:#cbd5e1;
      --heat1:#e6f0ff; --heat2:#c8e1ff; --heat3:#9fc9ff; --heat4:#6eaaff; --heat5:#ffd166;
      --focus:#2563eb33;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:var(--bg); color:var(--ink);
    }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:16px clamp(12px,4vw,28px); position:sticky; top:0; background:var(--bg);
      border-bottom:1px solid #0003;
    }
    .brand{font-weight:700; letter-spacing:0.3px}
    .controls{display:flex; flex-wrap:wrap; gap:8px}
    .controls > *{background:var(--card); border:1px solid #0003; color:var(--ink);
      padding:8px 10px; border-radius:10px; font-size:14px}
    .toggle{display:inline-flex; align-items:center; gap:8px; padding:6px 10px}
    main{max-width:1000px; margin:16px auto; padding:0 16px 48px}
    .card{
      background:var(--card); border:1px solid #0003; border-radius:var(--round);
      padding:18px; box-shadow:0 2px 16px #00000010;
    }
    .row{display:flex; gap:16px; align-items:stretch; flex-wrap:wrap}
    .col{flex:1 1 420px; min-width:320px}

    /* Typing area */
    .typing-wrap{position:relative; overflow:hidden}
    .text{
      font-family:var(--mono); font-size:20px; line-height:1.65; letter-spacing:0.2px;
      min-height:160px; padding:12px 10px; border-radius:10px; outline:none;
      user-select:none;
    }
    .word{margin-right:8px}
    .char{opacity:0.7}
    .char.correct{opacity:1}
    .char.wrong{color:var(--bad); background: #ff55550f; border-bottom:2px solid var(--bad)}
    .char.extra{color:var(--bad); opacity:1; border-bottom:2px dashed var(--bad)}
    .char.future{opacity:0.35}
    .caret{
      position:absolute; width:2px; background:var(--caret);
      animation:blink 1s step-end infinite;
      transform:translateY(3px); height:1.3em;
    }
    @keyframes blink{50%{opacity:0}}

    .bar{height:8px; background:#0002; border-radius:999px; overflow:hidden}
    .bar > span{display:block; height:100%; background:var(--accent); width:0%}

    .stats{display:grid; grid-template-columns: repeat(5, minmax(100px,1fr)); gap:10px; margin-top:14px}
    .stat{
      background:var(--key2); border:1px solid #0003; border-radius:10px; padding:10px 12px;
      display:flex; flex-direction:column; gap:4px;
    }
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-size:22px; font-weight:700; font-variant-numeric: tabular-nums}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      border:1px solid #0003; background:var(--accent); color:white; padding:10px 14px;
      border-radius:10px; font-weight:600; cursor:pointer
    }
    button.secondary{background:var(--key2); color:var(--ink)}
    button.ghost{background:transparent}
    button:focus-visible{outline:3px solid var(--focus); outline-offset:2px}

    /* Keyboard heatmap */
    .kbd{display:grid; gap:6px; grid-template-columns: repeat(30, 1fr); margin-top:10px}
    .key{
      background:var(--key); border:1px solid var(--key-border); border-radius:8px;
      padding:10px 0; text-align:center; font-family:var(--mono); font-size:12px;
      user-select:none;
    }
    .key[data-hit="1"]{background:var(--heat1)}
    .key[data-hit="2"]{background:var(--heat2)}
    .key[data-hit="3"]{background:var(--heat3)}
    .key[data-hit="4"]{background:var(--heat4)}
    .key[data-hit="5"]{background:var(--heat5)}
    .key.worst{box-shadow:0 0 0 2px var(--bad) inset}

    /* Leaderboard */
    .table{width:100%; border-collapse:collapse; font-variant-numeric: tabular-nums}
    .table th,.table td{padding:8px 10px; border-bottom:1px dashed #0003; text-align:left}
    .muted{color:var(--muted)}
    textarea.custom{width:100%; min-height:100px; font-family:var(--mono); font-size:14px; padding:10px}

    .note{font-size:12px; color:var(--muted); margin-top:6px}
    .pill{display:inline-block; padding:.25rem .5rem; border:1px solid #0003; border-radius:999px; font-size:12px}
  </style>
</head>
<body data-theme="dark">
<header>
  <div class="brand">⌨️ Typing Lab</div>
  <div class="controls" role="group" aria-label="Global controls">
    <select id="mode" title="Test type">
      <option value="time-30">30s timed</option>
      <option value="time-60" selected>60s timed</option>
      <option value="time-120">120s timed</option>
      <option value="words-25">25 words</option>
      <option value="words-50">50 words</option>
      <option value="words-100">100 words</option>
    </select>
    <select id="source" title="Text source">
      <option value="random" selected>Random english</option>
      <option value="punct">English + punctuation</option>
      <option value="custom">Custom text (below)</option>
    </select>
    <label class="toggle"><input type="checkbox" id="blind"> Blind mode</label>
    <label class="toggle"><input type="checkbox" id="sounds"> Key sound</label>
    <label class="toggle"><input type="checkbox" id="theme"> Light theme</label>
  </div>
</header>

<main>
  <div class="row">
    <div class="col">
      <div class="card typing-wrap" id="typingCard">
        <div class="bar" aria-hidden="true"><span id="progress"></span></div>
        <div id="text" class="text" tabindex="0" aria-label="Typing area"></div>
        <div id="caret" class="caret" aria-hidden="true"></div>

        <div class="actions">
          <button id="startBtn">Start (Space)</button>
          <button id="resetBtn" class="secondary">Reset</button>
          <button id="practiceBtn" class="ghost" title="Build practice from mistakes">Practice mistakes</button>
          <span class="pill" id="difficultyFlag" title="Adaptive difficulty status">difficulty: basic</span>
        </div>

        <div class="stats" aria-live="polite">
          <div class="stat"><span class="label">WPM</span><span class="value" id="wpm">0</span></div>
          <div class="stat"><span class="label">Raw WPM</span><span class="value" id="raw">0</span></div>
          <div class="stat"><span class="label">Accuracy</span><span class="value" id="acc">100%</span></div>
          <div class="stat"><span class="label">Errors</span><span class="value" id="errors">0</span></div>
          <div class="stat"><span class="label">Consistency</span><span class="value" id="cons">—</span></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3 style="margin-top:0">Keyboard heatmap</h3>
        <div id="kbd" class="kbd" aria-label="Keyboard heatmap"></div>
        <div class="note">Shows where mistakes cluster. Darker/warmer = more errors. The worst key is outlined.</div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3 style="margin-top:0">Custom text (optional)</h3>
        <textarea id="customText" class="custom" placeholder="Paste or type text to practice. Then select 'Custom text' in Text source."></textarea>
        <div class="note">Tip: add punctuation-heavy lines to challenge yourself.</div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3 style="margin-top:0">Local leaderboard</h3>
        <table class="table" id="board">
          <thead><tr><th>Date</th><th>Mode</th><th>WPM</th><th>Accuracy</th><th>Errors</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button id="exportBtn" class="secondary">Export results JSON</button>
          <button id="clearBtn" class="ghost">Clear leaderboard</button>
        </div>
        <div class="note">Stored only in your browser (no network).</div>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== Utilities ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const STORAGE_KEY = 'typingLab.results.v1';
const WORDS = `time people way day man thing woman life child world school state family student group country problem hand part place case week company system program question work night point home water room mother area money story fact month lot right study book eye job word business issue side kind head house service friend father power hour game line end member law car city community name president team minute idea kid body information back parent face others level office door health person art war history party result change morning reason research girl guy moment air teacher force education foot boy age policy everything process music market sense service`.split(' ');
const PUNCT = [',','.',';','!',':','?','—','-','"',"'",'(',')'];
const BIGRAMS = ['th','he','in','er','an','re','on','at','en','nd','ti','es','or','te','of','ed','is','it','al','ar'];
function randomWords(n, punct=false){
  const words=[];
  for(let i=0;i<n;i++){
    let w=WORDS[Math.floor(Math.random()*WORDS.length)];
    if(punct && Math.random()<0.18){
      const p=PUNCT[Math.floor(Math.random()*PUNCT.length)];
      if(Math.random()<0.5) w=w+p;
      else w=p+(Math.random()<0.3?' ':'')+w;
    }
    words.push(w);
  }
  if(Math.random()<0.4){
    words.splice(Math.floor(words.length/2),0,BIGRAMS[Math.floor(Math.random()*BIGRAMS.length)]);
  }
  return words.join(' ');
}

function prepareTextFromString(str){
  return str.trim().replace(/\s+/g,' ').split(' ').map(w=>`<span class="word">${[...w].map(c=>`<span class="char future" data-ch="${c}">${c}</span>`).join('')}<span class="char future" data-ch=" "> </span></span>`).join('');
}

function wpm(chars, ms){ const minutes=ms/60000; return minutes>0?Math.round((chars/5)/minutes):0; }

/* ===== State ===== */
const state = {
  started:false, finished:false, startTime:0, lastTime:0,
  pointer:0, typed:[], correct:0, wrong:0, extra:0,
  keystamps:[], errorsByKey:new Map(), errorsByBigram:new Map(), adaptive:'basic',
  limitType:'time', limitValue:60
};

/* ===== DOM refs ===== */
const elText=$('#text'), elCaret=$('#caret'), elProg=$('#progress'), elWpm=$('#wpm'), elRaw=$('#raw'), elAcc=$('#acc'), elErr=$('#errors'), elCons=$('#cons');
const elMode=$('#mode'), elSource=$('#source'), elBlind=$('#blind'), elSounds=$('#sounds'), elTheme=$('#theme');
const elStart=$('#startBtn'), elReset=$('#resetBtn'), elPractice=$('#practiceBtn'), elDiff=$('#difficultyFlag');
const elBoard=$('#board tbody'), elExport=$('#exportBtn'), elClear=$('#clearBtn'), elCustom=$('#customText');

/* ===== Theme ===== */
elTheme.addEventListener('change',()=>{document.body.dataset.theme=elTheme.checked?'light':'dark';});

/* ===== Text Generation / Custom Input Fix ===== */
function freshText(){
  let base='';
  if(elSource.value==='random') base=randomWords(80,false);
  else if(elSource.value==='punct') base=randomWords(80,true);
  else if(elSource.value==='custom'){
    const val=elCustom.value.trim();
    if(!val){ alert("Enter custom text!"); return; }
    base=val;
  }
  elText.innerHTML=prepareTextFromString(base);
  state.pointer=0; state.typed=[]; state.correct=0; state.wrong=0; state.extra=0;
  state.started=false; state.finished=false;
  elWpm.textContent='0'; elRaw.textContent='0'; elAcc.textContent='100%'; elErr.textContent='0'; elCons.textContent='—';
  placeCaret();
}

/* ===== Keyboard Heatmap ===== */
const KEY_LAYOUT=[['`','1','2','3','4','5','6','7','8','9','0','-','=','Back'],['Tab','q','w','e','r','t','y','u','i','o','p','[',']','\\'],['Caps','a','s','d','f','g','h','j','k','l',';',"'",'Enter'],['Shift','z','x','c','v','b','n','m',',','.','/','Shift'],['Space']];
function renderKeyboard(){
  const kbd=$('#kbd'); kbd.innerHTML='';
  kbd.style.gridTemplateColumns='repeat(30, 1fr)';
  KEY_LAYOUT.forEach(row=>{const totalUnits=row.reduce((s,key)=>s+keyWidth(key),0); row.forEach(key=>{const div=document.createElement('div'); div.className='key'; div.textContent=key==='Space'?'⎵ Space':key; div.style.gridColumn=`span ${Math.round(30*keyWidth(key)/totalUnits)}`; div.dataset.key=key.toLowerCase(); div.title='Errors: 0'; kbd.appendChild(div);});});
}
function keyWidth(key){if(key==='Back') return 5; if(key==='Tab'||key==='Caps') return 4; if(key==='Enter') return 5; if(key==='Shift') return 6; if(key==='Space') return 18; if(key.length===1) return 2; return 3;}
function updateHeatmap(){let max=0; state.errorsByKey.forEach(v=>{if(v>max)max=v;}); $$('.key').forEach(k=>{const label=k.dataset.key; const count=state.errorsByKey.get(label)||0; k.dataset.hit=count===0?'':String(Math.min(5,1+Math.floor(4*count/Math.max(1,max)))); k.classList.remove('worst');}); let worst=''; state.errorsByKey.forEach((v,k)=>{if(v===max) worst=k;}); if(worst) {const el=$(`.key[data-key="${worst}"]`); if(el) el.classList.add('worst');}}

/* ===== Caret ===== */
function placeCaret(){const chars=[...elText.querySelectorAll('.char')]; if(state.pointer>=chars.length) return; const rect=chars[state.pointer].getBoundingClientRect(); const parentRect=elText.getBoundingClientRect(); elCaret.style.top=(rect.top-parentRect.top)+'px'; elCaret.style.left=(rect.left-parentRect.left)+'px'; elCaret.style.height=rect.height+'px';}

/* ===== Typing Logic & Key Sound ===== */
function handleKey(e){
  if(!state.started || state.finished) return;
  e.preventDefault();
  const chars=[...elText.querySelectorAll('.char.future, .char.correct, .char.wrong, .char.extra')];
  if(state.pointer>=chars.length){state.finished=true; return;}
  const ch=e.key==='Enter'?'\n':e.key;
  const current=chars[state.pointer];
  if(ch===current.dataset.ch){current.classList.remove('future'); current.classList.add('correct'); state.correct++;} 
  else{current.classList.remove('future'); current.classList.add('wrong'); state.wrong++;
    state.errorsByKey.set(ch.toLowerCase(),(state.errorsByKey.get(ch.toLowerCase())||0)+1);
    const prevChar=state.pointer>0?chars[state.pointer-1].dataset.ch:''; 
    const bigram=prevChar+ch;
    state.errorsByBigram.set(bigram,(state.errorsByBigram.get(bigram)||0)+1);
  }
  state.typed.push(ch); state.pointer++; placeCaret();
  if(elSounds.checked){ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='square'; o.frequency.value=200; o.start(); o.stop(ctx.currentTime+0.05);}
  const elapsed=performance.now()-state.startTime;
  elWpm.textContent=wpm(state.correct,elapsed);
  elRaw.textContent=wpm(state.pointer,elapsed);
  elAcc.textContent=Math.round(100*state.correct/Math.max(1,state.pointer))+'%';
  elErr.textContent=state.wrong;
  updateHeatmap();
}

/* ===== Timer & Start / Reset ===== */
function start(){if(state.started) return; state.started=true; state.startTime=performance.now();}
function reset(){freshText(); state.errorsByKey.clear(); state.errorsByBigram.clear(); renderBoard(); renderKeyboard();}

/* ===== Practice from mistakes ===== */
function practiceFromMistakes(){
  const pairs=[...state.errorsByBigram.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);
  const keys=[...state.errorsByKey.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]).filter(k=>k!=='space');
  if(pairs.length===0 && keys.length===0){ alert('No mistakes recorded yet. Do a test first!'); return; }
  let chunks=[];
  if(pairs.length) chunks.push(...pairs.map(p=> `${p}${Math.random()<0.5?p:''}`));
  if(keys.length) chunks.push(...keys.map(k=> `${k}${k}${k}`));
  elCustom.value=chunks.join(' ').repeat(4);
  elSource.value='custom';
  freshText();
}

/* ===== Leaderboard ===== */
function loadResults(){try{const list=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); return Array.isArray(list)?list:[];}catch{return []}}
function saveResult(){const record={at:new Date().toISOString(), mode:elMode.value, wpm:Number(elWpm.textContent), accuracy:Number(elAcc.textContent.replace('%','')), errors:Number(elErr.textContent)}; const list=loadResults(); list.push(record); localStorage.setItem(STORAGE_KEY,JSON.stringify(list.slice(-50))); renderBoard();}
function renderBoard(){const list=loadResults().slice().reverse().slice(0,10); elBoard.innerHTML=list.map(r=>{const d=new Date(r.at); return `<tr><td class="muted">${d.toLocaleString()}</td><td>${r.mode}</td><td>${r.wpm}</td><td>${r.accuracy}%</td><td>${r.errors}</td></tr>`;}).join('')||`<tr><td colspan="5" class="muted">No results yet.</td></tr>`;}
function exportResults(){const data=localStorage.getItem(STORAGE_KEY)||'[]'; const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='typing-results.json'; a.click(); URL.revokeObjectURL(url);}

/* ===== Wiring ===== */
function applyModeFromSelect(){const [kind,val]=elMode.value.split('-'); state.limitType=kind; state.limitValue=parseInt(val,10);}
elMode.addEventListener('change',()=>{applyModeFromSelect(); freshText();});
elSource.addEventListener('change',()=>freshText());
elStart.addEventListener('click',()=>start());
elReset.addEventListener('click',()=>reset());
elPractice.addEventListener('click',()=>practiceFromMistakes());
elExport.addEventListener('click',()=>exportResults());
elClear.addEventListener('click',()=>{localStorage.removeItem(STORAGE_KEY); renderBoard();});
elBlind.addEventListener('change',()=>{elText.style.filter=elBlind.checked?'blur(4px) saturate(0.8)':'none'; elText.style.userSelect=elBlind.checked?'none':'text';});
document.addEventListener('keydown', e=>{if(e.key===' '&&!state.started){e.preventDefault(); start(); return;} if(document.activeElement!==elText) elText.focus({preventScroll:true}); if(!state.started||state.finished) return; handleKey(e);});
window.addEventListener('resize',placeCaret); elText.addEventListener('click',placeCaret);

/* ===== Init ===== */
applyModeFromSelect(); freshText(); renderBoard(); renderKeyboard();

</script>
</body>
</html>
